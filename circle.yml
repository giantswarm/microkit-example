machine:
    services:
        - docker
    environment:
        CGO_ENABLED: "0"
        GOOS: "linux"
        GOARCH: "amd64"
        GOPATH: "$HOME/go"
        GS_WD: "$HOME/go/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"

dependencies:
    override:
        - mkdir -p $HOME/go/src/github.com/$CIRCLE_PROJECT_USERNAME
        - cp -rf $HOME/$CIRCLE_PROJECT_REPONAME $HOME/go/src/github.com/$CIRCLE_PROJECT_USERNAME

test:
    override:
        - cd $GS_WD && go test
        - cd $GS_WD && go build -a -v -tags netgo -ldflags "-w -X main.gitCommit=$(git rev-parse --short HEAD) -X main.projectVersion=$(cat VERSION)"
        - cd $GS_WD && docker build --rm=false -t registry.giantswarm.io/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1 .
        - cd $GS_WD && docker run registry.giantswarm.io/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1 version
